<!DOCTYPE html>
<html lang="no">
<head>
    <title>My Home Automation</title>
    <style>
        body {
            height: auto;
            min-height: 100%;
            background-color: #16171c;
            color: #fff;
            font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 13px;
        }

        h3 {
            color: #88B252;
            text-decoration: underline;
        }

        /*
            #88B252
            #EEC14D
        */

        #header {
            background-color: #353c42;
        }
        #main {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }
        .widget {
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            width: 400px;
        }
        .icon {
            font-size: 12px;
            filter: grayscale(100%);
        }
        .title {
            background-color: #88B252;
            color: #000000;
            font-size: 16px;
            font-weight: bold;
            padding: 2px;
        }
        .add {
            color: #b0b0b0;
        }
        iframe {
            width: 100%;
            height: 420px;
            border: none;
        }

        ul {
            list-style: none;
            padding: 0;  /* Removes default left indentation */
            margin: 0;
        }

        .situation {
            padding: 0 !important;
        }
    </style>
</head>
<body>
   <div id="header">
    Header | Option 1 | Option 2
   </div>
   <div id="main">
   </div>

   <script>
    const weatherIcons = {
        "clearsky": "‚òÄÔ∏è",
        "partlycloudy": "‚õÖ",
        "cloudy": "‚òÅÔ∏è",
        "rainshowers": "üå¶",
        "lightrain": "üåß",
        "heavyrain": "üåßüåß",
        "thunderstorm": "‚õà",
        "snow": "‚ùÑÔ∏è"
    };

    function getCustomWeatherIcon(symbolCode) {
        return weatherIcons[symbolCode] || "‚ùì";  // Default icon if unknown
    }

    async function loadWidgets() {
        const response = await fetch("/widgets"); // Get list of widgets
        const widgets = await response.json();

        for (const widget of widgets) {
            const dataResponse = await fetch(widget.endpoint);
            const widgetData = await dataResponse.json();

            const widgetDiv = document.createElement("div");
            widgetDiv.classList.add("widget");

            if (widgetData.iframe) {
                const iframe = document.createElement("iframe");
                iframe.src = widgetData.iframe;
                widgetDiv.appendChild(iframe);
            } else {
                const ph = document.createElement("div");
                ph.classList.add('title');
                ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                widgetDiv.appendChild(ph);

                if(widget.endpoint === "/weather") {
                    const list = document.createElement("ul");
                    const listItem = document.createElement("li");

                    // ‚úÖ Correctly get `symbol_code`
                    if (widgetData.data.symbol_code) {
                        listItem.innerHTML = `${getCustomWeatherIcon(widgetData.data.symbol_code)} 
                                            ${widgetData.data.air_temperature}¬∞C`;
                    } else {
                        listItem.innerText = "Weather data unavailable";
                    }

                    list.appendChild(listItem);
                    widgetDiv.appendChild(list);
                }
                else if(widget.endpoint === "/calendar") {
                    const list = document.createElement("ul");
                    widgetData.data.forEach(item => {
                        const listItem = document.createElement("li");
                        listItem.innerHTML = `<p><span class="add">${item.start}:</span> ${item.summary}</p>`;
                        list.appendChild(listItem);
                    });
                    widgetDiv.appendChild(list);
                }
                else {
                    if (widgetData.data) {
                        if (Array.isArray(widgetData.data)) {
                            // üìå If data is an array (e.g., Calendar)
                            const list = document.createElement("ul");
                            widgetData.data.forEach(item => {
                                const listItem = document.createElement("li");
                                listItem.innerText = `${item.summary} - ${item.start}`;
                                list.appendChild(listItem);
                            });
                            widgetDiv.appendChild(list);
                        } else if (typeof widgetData.data === "object") {
                            // üìå If data is an object (e.g., Weather)
                            Object.entries(widgetData.data).forEach(([key, value]) => {
                                const p = document.createElement("p");
                                p.innerText = `${key.replace(/_/g, " ")}: ${value}`;
                                widgetDiv.appendChild(p);
                            });
                        } else {
                            // üìå Default text format
                            const p = document.createElement("p");
                            p.innerText = widgetData.data;
                            widgetDiv.appendChild(p);
                        }
                    }
                }
            }
            document.getElementById("main").appendChild(widgetDiv);
        }
    }

    loadWidgets();
</script>
    
</body>
</html>