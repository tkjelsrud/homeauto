<!DOCTYPE html>
<html lang="no">
<head>
    <title>My Home Automation</title>
    <style>
        html, body {
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
        body {
            transform: scale(1.1); /* 1.2 = 120% scale */
            transform-origin: top left; /* Keeps it aligned */
            height: auto;
            min-height: 100%;
            background-color: #16171c;
            color: #fff;
            font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 15px;
            margin: 0;
        }

        h3 {
            color: #88B252;
            text-decoration: underline;
        }

        a {
            color: #fff;
            text-decoration: none;
        }

        /*
            #88B252
            #EEC14D
        */

        #header {
            background-color: #242628;
            font-size: 17px;
            padding: 4px;
            border-bottom: 1px solid #21330a;
        }
        #main {
            display: flex;
            flex-wrap: wrap;
            padding: 14px;
        }
        .widget {
            padding: 8px;
            margin: 8px;
            border-radius: 2px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            width: 380px;
            background: linear-gradient(to bottom, #1c1e25, #14161d);
        }
        #widget-bigcalendar {
            width: 1216px !important;
        }
        .icon {
            font-size: 12px;
            filter: grayscale(100%);
        }
        .title {
            border-bottom: 3px solid #414639;
            /*background-color: #414639;*/
            color: #EEC14D;
            font-size: 18px;
            font-weight: 200;
            padding: 4px;
        }
        .add {
            color: #b0b0b0;
        }
        .on {
            background-color: #21330a;
            color: #88B252;
        }
        .off {
            background-color: #21190d;
            color: #886e5c;
        }
        .active {
            background-color: #EEC14D !important;
            color: #240825;
        }
        .wide {
            width: 100% !important;
        }
        .float {
            float: left;
            width: 156px;
            margin-top: 4px;
            margin-right: 4px;
            margin-bottom: 6px;
            border-radius: 8px;
            padding: 4px;
        }
        .line {
            margin-top: 4px;
            margin-right: 4px;
            margin-bottom: 6px;
            border-radius: 8px;
            padding: 4px;
        }
        .calday {
            float: left;
            width: 162px;
            height: 480px;
            margin-top: 4px;
            padding: 4px;
        }
        .today {
            background-color: #19062f;
        }
        .calday-header {
            background-color: #242628;
            font-size: 17px;
            padding: 4px;
            border-bottom: 1px solid #21330a;
        }
        .dinner {
            padding: 6px;
            background-color: #2d4407;
            font-style: italic;
        }
        .big {
            font-size: 17px;
        }
        .biggar {
            font-size: 22px;
        }
        .biggast {
            font-size: 86px;
        }
        .subdue {
            opacity: 0.6;
        }
        iframe {
            width: 100%;
            height: 360px;
            border: none;
        }

        ul {
            list-style: none;
            margin-top: 4px;
            padding: 0;  /* Removes default left indentation */
            margin: 0;
        }

        li {
            margin-bottom: 2px; /* Reduce space between items */
            line-height: 1.0; /* Adjust text spacing */
        }

        .situation {
            padding: 0 !important;
        }

        .weather-icon {
            font-size: 1.2em;
            font-weight: bold;
            color: #EEC14D;
            display: inline-block;
            min-width: 1.5em;
            text-align: center;
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
   <div id="header">
    <i class="fa-brands fa-raspberry-pi"></i> <a href="http://kjelpi.local:5000/">kjelpi</a> | <a href="http://kjelpi.local:5000/update">update</a> | <a href="http://kjelpi.local/admin/login">Pi-hole</a> 
    <!-- | <span id="clock">Time...</span-->
   </div>
   <div id="main">
   </div>

   <script>
    const weatherIcons = {
        "clearsky_day": "‚òº",
        "clearsky_night": "‚òΩ",
        "clearsky_polartwilight": "‚òº",
        "fair_day": "‚òº",
        "fair_night": "‚òΩ",
        "fair_polartwilight": "‚òº",
        "partlycloudy_day": "‚õÖ",
        "partlycloudy_night": "‚òÅ",
        "partlycloudy_polartwilight": "‚õÖ",
        "cloudy": "‚òÅ",
        "rainshowers_day": "üå¶",
        "rainshowers_night": "üåß",
        "rainshowers_polartwilight": "üå¶",
        "lightrain": "üåß",
        "rain": "üåß",
        "heavyrain": "üåß",
        "lightrainshowers_day": "üå¶",
        "lightrainshowers_night": "üåß",
        "lightrainshowers_polartwilight": "üå¶",
        "heavyrainshowers_day": "üåß",
        "heavyrainshowers_night": "üåß",
        "heavyrainshowers_polartwilight": "üåß",
        "lightrainandthunder": "‚õà",
        "rainandthunder": "‚õà",
        "heavyrainandthunder": "‚õà",
        "lightrainshowersandthunder_day": "‚õà",
        "lightrainshowersandthunder_night": "‚õà",
        "lightrainshowersandthunder_polartwilight": "‚õà",
        "rainshowersandthunder_day": "‚õà",
        "rainshowersandthunder_night": "‚õà",
        "rainshowersandthunder_polartwilight": "‚õà",
        "heavyrainshowersandthunder_day": "‚õà",
        "heavyrainshowersandthunder_night": "‚õà",
        "heavyrainshowersandthunder_polartwilight": "‚õà",
        "lightsleet": "üå®",
        "sleet": "üå®",
        "heavysleet": "üå®",
        "lightsleetshowers_day": "üå®",
        "lightsleetshowers_night": "üå®",
        "lightsleetshowers_polartwilight": "üå®",
        "sleetshowers_day": "üå®",
        "sleetshowers_night": "üå®",
        "sleetshowers_polartwilight": "üå®",
        "heavysleetshowers_day": "üå®",
        "heavysleetshowers_night": "üå®",
        "heavysleetshowers_polartwilight": "üå®",
        "lightsnow": "‚ùÑ",
        "snow": "‚ùÑ",
        "heavysnow": "‚ùÑ",
        "lightsnowshowers_day": "‚ùÑ",
        "lightsnowshowers_night": "‚ùÑ",
        "lightsnowshowers_polartwilight": "‚ùÑ",
        "snowshowers_day": "‚ùÑ",
        "snowshowers_night": "‚ùÑ",
        "snowshowers_polartwilight": "‚ùÑ",
        "heavysnowshowers_day": "‚ùÑ",
        "heavysnowshowers_night": "‚ùÑ",
        "heavysnowshowers_polartwilight": "‚ùÑ",
        "fog": "‚â°",
        "thunderstorm": "‚õà"
    };

    function getCustomWeatherIcon(symbolCode) {
        // Remove "_day", "_night", "_polartwilight" suffix for matching if not found
        let icon = weatherIcons[symbolCode];
        if (!icon) {
            const baseCode = symbolCode.replace(/_(day|night|polartwilight)$/, "");
            icon = weatherIcons[baseCode] || "?";
        }
        return `<span class="weather-icon">${icon}</span>`;
    }

    function getShortDay(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("nb-NO", { weekday: "short" }); // "Sun"
    }

    async function loadWidgets() {
        const response = await fetch("/widgets"); // Get list of widgets
        const widgets = await response.json();

        for (const widget of widgets) {
            await updateWidget(widget.endpoint); // Initial load
        };
    }

    async function updateWidget(endpoint) {
        try {
            const response = await fetch(endpoint);
            const widgetData = await response.json();
            
            const widgetId = `widget-${endpoint.replace("/", "")}`; // Generate ID from endpoint
            let widgetDiv = document.getElementById(widgetId);

            if (!widgetDiv) {
                // Create widget container if it doesn't exist
                widgetDiv = document.createElement("div");
                widgetDiv.id = widgetId;
                widgetDiv.classList.add("widget");
                document.getElementById("main").appendChild(widgetDiv);
            }

            widgetDiv.innerHTML = "";

            // Update widget content dynamically
            if (widgetData.iframe) {
                const iframe = document.createElement("iframe");
                iframe.src = widgetData.iframe;
                widgetDiv.appendChild(iframe);
            } else {
                
                if(endpoint === "/weather") {
                    const list = document.createElement("div");
                    let listItem = document.createElement("div");

                    listItem.classList.add("line", "biggast");
                    listItem.innerHTML = `<span id="clock">&nbsp;</span>`;
                    list.appendChild(listItem);

                    we = widgetData.data.instant.details;
                    listItem = document.createElement("div");
                    listItem.classList.add("line", "biggar","active");
                    listItem.innerHTML = `${we.air_temperature}¬∞ ${getCustomWeatherIcon(widgetData.data.next_1_hours.summary.symbol_code)}`;
                    list.appendChild(listItem);

                    // next_1_hours
                    we = widgetData.data.next_1_hours;
                    listItem = document.createElement("div");
                    listItem.classList.add("line", "big");
                    precipitation_amount = (we.details.precipitation_amount > 0 ? ` ${we.details.precipitation_amount}mm` : "");
                    listItem.innerHTML = `1 time: ${getCustomWeatherIcon(we.summary.symbol_code)} ${precipitation_amount}`;
                    list.appendChild(listItem);

                    we = widgetData.data.next_6_hours;
                    listItem = document.createElement("div");
                    listItem.classList.add("line", "big");
                    precipitation_amount = (we.details.precipitation_amount > 0 ? ` ${we.details.precipitation_amount}mm` : "");
                    listItem.innerHTML = `6 timer: ${getCustomWeatherIcon(we.summary.symbol_code)} ${precipitation_amount}`;
                    list.appendChild(listItem);
                    
                    widgetDiv.appendChild(list);
                }
                else if(endpoint === "/calendar") {
                    const list = document.createElement("ul");
                    widgetData.data.forEach(item => {
                        const listItem = document.createElement("li");
                        const eventDateTime = new Date(item.start);
                        const eventDate = new Date(item.start).toISOString().split("T")[0]; // Get YYYY-MM-DD
                        const todayDate = new Date().toISOString().split("T")[0]; // Get today's date in YYYY-MM-DD format
                        const eventTime = eventDateTime.toLocaleTimeString("no-NO", {
                            hour: "2-digit",
                            minute: "2-digit",
                            hour12: false, // Ensures 24-hour format
                        });

                        // Add class if not today
                        if (eventDate !== todayDate) {
                            listItem.classList.add("subdue");
                        }
                        listItem.innerHTML = `<p><span class="add">${eventDate} ${eventTime}</span> ${item.summary}</p>`;
                        list.appendChild(listItem);
                    });
                    widgetDiv.appendChild(list);
                }
                else if (endpoint === "/bigcalendar") {
                    try {
                        if (!widgetData.data || !Array.isArray(widgetData.data)) {
                            throw new Error("Invalid calendar data structure");
                        }

                        const todayIndex = new Date().getDay();  
                        const correctedToday = (todayIndex + 6) % 7;

                        const week = widgetData.data;  // array med 7 dager
                        const list = document.createElement("div");
                        list.classList.add("week-grid"); // hvis du vil lage grid i CSS

                        week.forEach(day => {
                        const dayColumn = document.createElement("div");
                        dayColumn.classList.add("calday");



                        // Header: Dag + middag
                        const header = document.createElement("div");
                        header.classList.add("calday-header");
                        header.innerHTML = `
                            <div class="day-name">${day.name}</div>
                        `;

                        if (day.weekday_index === correctedToday) {
                            dayColumn.classList.add("today");
                            header.classList.add("active");
                        }

                        dayColumn.appendChild(header);

                        // Eventliste
                        const eventList = document.createElement("ul");

                        // Ingen events?
                        if (!day.events || day.events.length === 0) {
                            const empty = document.createElement("li");
                            empty.classList.add("subdue");
                            empty.textContent = "Ingen hendelser";
                            eventList.appendChild(empty);
                        }

                        day.events.forEach(evt => {
                            try {
                                const li = document.createElement("li");

                                // Fargelegg neste-uke-eventer
                                if (evt.is_next_week) {
                                    li.classList.add("nextweek"); // legg til CSS
                                }

                                const dt = new Date(evt.start);
                                const dateStr = dt.toLocaleDateString("no-NO");
                                const timeStr = dt.toLocaleTimeString("no-NO", {
                                    hour: "2-digit",
                                    minute: "2-digit"
                                });

                                li.innerHTML = `
                                    <div>
                                        <span class="add">${timeStr}</span>
                                        ${evt.summary || "Ingen tittel"}
                                        ${evt.is_next_week ? ` <span class="subdue">(neste uke)</span>` : ""}
                                    </div>
                                `;

                                eventList.appendChild(li);
                            } catch (err) {
                                console.error("Error rendering event:", err, evt);
                            }
                        });

                        dayColumn.appendChild(eventList);

                        const dinnar = document.createElement("div");
                        dinnar.classList.add("day-header");
                        dinnar.innerHTML = day.dinner ? `<div class="dinner">üçΩÔ∏è ${day.dinner}</div>` : "";

                        dayColumn.appendChild(dinnar);

                        // S√∏ppelhenting (hvis aktuelt for denne uken)
                        if (day.waste && day.waste.length > 0) {
                            const wasteContainer = document.createElement("div");
                            wasteContainer.style.padding = "6px";
                            wasteContainer.style.marginTop = "4px";
                            wasteContainer.style.backgroundColor = "#2d1a07";
                            wasteContainer.style.borderRadius = "4px";
                            wasteContainer.style.fontSize = "14px";
                            
                            day.waste.forEach(waste => {
                                const wasteItem = document.createElement("div");
                                wasteItem.textContent = `${waste.icon} ${waste.type}`;
                                wasteContainer.appendChild(wasteItem);
                            });
                            
                            dayColumn.appendChild(wasteContainer);
                        }

                        // Timeplaner (kun for dagens dag)
                        if (day.timeplaner && Object.keys(day.timeplaner).length > 0) {
                            const timeplanContainer = document.createElement("div");
                            timeplanContainer.style.fontSize = "12px";
                            timeplanContainer.style.marginTop = "8px";
                            timeplanContainer.style.padding = "4px";

                            const barnNames = Object.keys(day.timeplaner);
                            
                            // Show each child vertically
                            barnNames.forEach(barnNavn => {
                                // Header with child name
                                const header = document.createElement("div");
                                header.textContent = barnNavn;
                                header.style.fontWeight = "bold";
                                header.style.color = "#EEC14D";
                                header.style.fontSize = "13px";
                                header.style.marginTop = "6px";
                                header.style.marginBottom = "2px";
                                header.style.borderBottom = "1px solid #414639";
                                header.style.paddingBottom = "2px";
                                timeplanContainer.appendChild(header);
                                
                                // List of subjects
                                const fagList = day.timeplaner[barnNavn];
                                fagList.forEach(fag => {
                                    const fagDiv = document.createElement("div");
                                    fagDiv.textContent = fag;
                                    fagDiv.style.paddingLeft = "4px";
                                    fagDiv.style.marginBottom = "1px";
                                    timeplanContainer.appendChild(fagDiv);
                                });
                            });

                            dayColumn.appendChild(timeplanContainer);
                        }

                        list.appendChild(dayColumn);
                        });

                        widgetDiv.appendChild(list);
                    } catch (error) {
                        console.error("Bigcalendar render error:", error);
                        const errorDiv = document.createElement("div");
                        errorDiv.style.padding = "10px";
                        errorDiv.style.color = "#ff6b6b";
                        errorDiv.textContent = "‚ö†Ô∏è Kunne ikke laste kalender: " + error.message;
                        widgetDiv.appendChild(errorDiv);
                    }
                }
                else if(endpoint === "/lights") {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);
                    
                    const list = document.createElement("div");
                    widgetData.data.forEach(item => {
                        const listItem = document.createElement("div");
                        listItem.classList.add(item.status.toLowerCase());
                        listItem.classList.add("float");
                        listItem.innerHTML = `${item.name} (${item.num_lights} lys)`;
                        list.appendChild(listItem);
                    });
                    widgetDiv.appendChild(list);
                }
                else if (endpoint === "/energy") {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);

                    const we = widgetData.data; 
                    const list = document.createElement("div");

                    const fmt = x => (typeof x === "number" ? x.toFixed(2) : "‚Äì");

                    // N√•
                    const nowEl = document.createElement("div");
                    nowEl.classList.add("float", "biggar", "active");
                    nowEl.innerHTML = `
                        ${fmt(we.now.price)} kr/kWh 
                        <span class="subdue">(n√•)</span>
                    `;
                    list.appendChild(nowEl);

                    // Neste time
                    const nextEl = document.createElement("div");
                    nextEl.classList.add("float", "off");
                    nextEl.innerHTML = `
                        Neste: ${fmt(we.next.price)} kr/kWh
                    `;
                    list.appendChild(nextEl);

                    // H√∏yeste i dag
                    const maxTodayEl = document.createElement("div");
                    maxTodayEl.classList.add("float", "off");
                    maxTodayEl.innerHTML = `
                        H√∏yeste i dag: ${fmt(we.max_today.price)} kr/kWh
                    `;
                    list.appendChild(maxTodayEl);

                    // H√∏yeste i morgen
                    const maxTomorrowEl = document.createElement("div");
                    maxTomorrowEl.classList.add("float", "off");
                    maxTomorrowEl.innerHTML = `
                        H√∏yeste i morgen: ${fmt(we.max_tomorrow.price)} kr/kWh
                    `;
                    list.appendChild(maxTomorrowEl);

                    widgetDiv.appendChild(list);
                }
                else if (endpoint === "/mill") {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);

                    const millData = widgetData.data;
                    
                    // Check for errors
                    if (millData.error) {
                        const errorDiv = document.createElement("div");
                        errorDiv.classList.add("float", "off");
                        errorDiv.textContent = `Feil: ${millData.error}`;
                        widgetDiv.appendChild(errorDiv);
                    } else {
                        const rooms = millData.rooms || {};
                        
                        Object.keys(rooms).forEach(roomName => {
                            const devices = rooms[roomName];
                            
                            // Devices in room
                            devices.forEach(device => {
                                const deviceDiv = document.createElement("div");
                                deviceDiv.classList.add("float");
                                
                                const connectedIcon = device.connected ? "‚úì" : "‚úó";
                                const connectedClass = device.connected ? "active" : "off";
                                
                                const ambientTemp = device.ambient_temp != null ? device.ambient_temp.toFixed(1) : "‚Äì";
                                const targetTemp = device.target_temp != null ? device.target_temp : "‚Äì";
                                const power = device.power != null ? device.power : 0;
                                
                                // Calculate temperature difference and color gradient
                                let tempColor = "#ffffff"; // default white
                                if (device.ambient_temp != null && device.target_temp != null) {
                                    const diff = device.ambient_temp - device.target_temp;
                                    const absDiff = Math.abs(diff);
                                    
                                    if (absDiff < 2) {
                                        // Within 2 degrees - dark gray (close to target)
                                        tempColor = "#555555";
                                    } else if (diff < 0) {
                                        // Below target - blue gradient (colder = more blue)
                                        // Scale: 2-10 degrees below = light to deep blue
                                        const intensity = Math.min((absDiff - 2) / 8 * 200, 200);
                                        tempColor = `rgb(${Math.floor(255 - intensity)}, ${Math.floor(255 - intensity/2)}, 255)`;
                                    } else {
                                        // Above target - red gradient (warmer = more red)
                                        // Scale: 2-7 degrees above = light to deep red
                                        const intensity = Math.min((absDiff - 2) / 5 * 200, 200);
                                        tempColor = `rgb(255, ${Math.floor(255 - intensity)}, ${Math.floor(255 - intensity)})`;
                                    }
                                }
                                
                                deviceDiv.classList.add(connectedClass);
                                deviceDiv.innerHTML = `
                                    <strong>${roomName}</strong> ${connectedIcon}<br>
                                    <span style="font-size: 24px; font-weight: bold; color: ${tempColor}">${ambientTemp}¬∞C</span> / <span style="font-size: 16px; color: #aaa;">${targetTemp}¬∞C</span><br>
                                    ${power}W
                                `;
                                
                                widgetDiv.appendChild(deviceDiv);
                            });
                        });
                    }
                }
                else if(endpoint === "/network") {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);

                    const list = document.createElement("div");
                    
                    we = widgetData.data;

                    we.forEach(item => {
                        let listItem = document.createElement("div");
                        listItem.classList.add("float", (item.status == "Up" ? "on": "off"));
                        var name = item.name.replace(".home", "");
                        listItem.innerHTML = `${name} (${item.vendor})`;
                        list.appendChild(listItem);
                    });

                    widgetDiv.appendChild(list);
                }
                else if(endpoint === "/music") {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);

                    const list = document.createElement("ul");

                    we = widgetData.data;
                    
                    let listItem = document.createElement("li");
                    listItem.innerHTML = `<p>${we.title}: ${we.state} | Volume: ${we.volume} <span="subdue">(${we.db} db)</span></p>`;
                    list.appendChild(listItem);

                    widgetDiv.appendChild(list);
                }
                else if(endpoint === "/dinner") {
                    const list = document.createElement("ul");
                    if(widgetData.data.important != "") {
                        const impDiv = document.createElement("div");
                        impDiv.classList.add("float", "active", "biggar", "wide");
                        impDiv.innerHTML = `${widgetData.data.important}`;
                        widgetDiv.appendChild(impDiv);
                    }

                    maxDays = 5;
                    widgetData.data.days.forEach(item => {
                        if(maxDays-- > 0) {
                            const listItem = document.createElement("li");
                            const eventDate = item.date.split(" ")[0]; // "2025-03-10"
                            const todayDate = new Date().toISOString().split("T")[0];

                            // Debugging
                            console.log(`Event Date: ${eventDate}, Today: ${todayDate}`);

                            // Add class if not today
                            if (eventDate !== todayDate) {
                                listItem.classList.add("subdue");
                            }

                            listItem.innerHTML = `<p><span class="add">${eventDate}</span> ${item.description}</p>`;
                            list.appendChild(listItem);
                        }
                    });
                    widgetDiv.appendChild(list);
                }
                else {
                    const ph = document.createElement("div");
                    ph.classList.add('title');
                    ph.innerHTML = `<span class="icon">${widgetData.icon}</span> ${widgetData.title}`;
                    widgetDiv.appendChild(ph);

                    if (typeof widgetData.data === "object") {
                        Object.entries(widgetData.data).forEach(([key, value]) => {
                            const title = document.createElement("h3");
                            title.innerText = key.replace(/_/g, " ");
                            widgetDiv.appendChild(title);

                            if (Array.isArray(value)) {
                                const list = document.createElement("ul");
                                value.forEach(item => {
                                    const listItem = document.createElement("li");
                                    listItem.innerText = item;
                                    list.appendChild(listItem);
                                });
                                widgetDiv.appendChild(list);
                            } else {
                                const p = document.createElement("p");
                                p.innerText = value;
                                widgetDiv.appendChild(p);
                            }
                        });
                    }
                }
            }

            // Refresh at specified interval (default to 30s if missing)
            if(widgetData.refresh) {
                const refreshRate = (widgetData.refresh) * 1000;
                // Clear previous interval and set new one
                if (widgetDiv.refreshInterval) clearTimeout(widgetDiv.refreshInterval);
                widgetDiv.refreshInterval = setTimeout(() => updateWidget(endpoint), refreshRate);
            }

            
        } catch (error) {
            console.error(`Error loading ${endpoint}:`, error);
            
            // Show error in widget
            const widgetId = `widget-${endpoint.replace("/", "")}`;
            let widgetDiv = document.getElementById(widgetId);
            
            if (!widgetDiv) {
                widgetDiv = document.createElement("div");
                widgetDiv.id = widgetId;
                widgetDiv.classList.add("widget");
                document.getElementById("main").appendChild(widgetDiv);
            }
            
            widgetDiv.innerHTML = `
                <div style="padding: 10px; color: #ff6b6b;">
                    <strong>‚ö†Ô∏è Widget Error: ${endpoint}</strong><br>
                    <span style="font-size: 12px; color: #aaa;">${error.message}</span>
                </div>
            `;
            
            // Retry after 30 seconds
            setTimeout(() => updateWidget(endpoint), 30000);
        }
    }

    loadWidgets();

    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        
        if(document.getElementById("clock") != null)
            document.getElementById("clock").textContent = `${hours}:${minutes}:${seconds}`;
    }

    // Run once immediately
    updateClock();

    // Update every second
    setInterval(updateClock, 1000);

    document.addEventListener("DOMContentLoaded", function () {
        // Select all elements with the class "widget"
        document.querySelectorAll(".widget").forEach(widget => {
            widget.onclick = function () {
                alert("Hello");
            };
        });
    });

    let lastReloadedHour = null;

    setInterval(() => {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();

        if (currentMinute === 0 && currentHour !== lastReloadedHour) {
            lastReloadedHour = currentHour;
            console.log(`üîÅ Reloading at full hour: ${currentHour}:00`);
            location.reload(); // Reload siden √©n gang per ny hel time
        }
    }, 60 * 1000); // Sjekk hvert minutt
</script>
    
</body>
</html>